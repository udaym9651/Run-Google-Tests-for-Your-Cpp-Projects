name: CI (Build + Test + LCOV Coverage)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  coverage:
    runs-on: ubuntu-24.04

    env:
      BUILD_DIR: build
      # Force lcov/geninfo to use the GCC-matching gcov on Ubuntu 24.04 (GCC 13)
      GCOV: gcov-13

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (GCC, CMake, LCOV)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            gcc-13 g++-13 \
            cmake ninja-build \
            lcov \
            gcovr

          gcc-13 --version
          g++-13 --version
          lcov --version
          ${GCOV} --version

      # Optional: speed up builds (CMake cache)
      - name: Cache build directory
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.BUILD_DIR }}
          key: ${{ runner.os }}-cmake-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-cmake-

      - name: Configure (CMake + coverage flags)
        run: |
          cmake -S . -B "${BUILD_DIR}" -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=gcc-13 \
            -DCMAKE_CXX_COMPILER=g++-13 \
            -DCMAKE_C_FLAGS="--coverage -O0 -g -fno-inline -fno-optimize-sibling-calls" \
            -DCMAKE_CXX_FLAGS="--coverage -O0 -g -fno-inline -fno-optimize-sibling-calls" \
            -DCMAKE_EXE_LINKER_FLAGS="--coverage" \
            -DCMAKE_SHARED_LINKER_FLAGS="--coverage"

      - name: Build
        run: |
          cmake --build "${BUILD_DIR}" --parallel

      - name: Run tests
        run: |
          ctest --test-dir "${BUILD_DIR}" --output-on-failure

      - name: Capture LCOV
        run: |
          # Clean old counters (important for PR builds / reused runners)
          lcov --directory "${BUILD_DIR}" --zerocounters || true

          # Capture coverage
          lcov --capture \
               --directory "${BUILD_DIR}" \
               --output-file coverage.info \
               --rc lcov_branch_coverage=1 \
               --gcov-tool "${GCOV}"

          # Remove noise (system + deps + tests)
          lcov --remove coverage.info \
               '/usr/*' \
               '*/_deps/*' \
               '*/external/*' \
               '*/third_party/*' \
               '*/tests/*' \
               --output-file coverage.filtered.info \
               --rc lcov_branch_coverage=1

          # Show summary in logs
          lcov --summary coverage.filtered.info --rc lcov_branch_coverage=1

      - name: Generate HTML report
        run: |
          genhtml coverage.filtered.info \
            --output-directory coverage_html \
            --branch-coverage \
            --title "LCOV Coverage Report"

      - name: Upload LCOV artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lcov-coverage
          path: |
            coverage.info
            coverage.filtered.info
            coverage_html
          if-no-files-found: error
